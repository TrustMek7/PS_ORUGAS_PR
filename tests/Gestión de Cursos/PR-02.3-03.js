import http from 'k6/http';
import { check, sleep } from 'k6';
import { getHeadersWithCSRF } from '../login_token.js';

export const options = {
  vus: 1,           // UN SOLO usuario para acciones masivas
  iterations: 100,  // Eliminar 100 cursos secuencialmente
  duration: '10m',  // Tiempo m√°ximo permitido para completar el proceso
};

// Informaci√≥n del administrador para acceder a los cursos
const administrador = {
  email: 'jcusilaymeg@unsa.edu.pe',  // Usuario funcional descubierto
  name: 'Juan Carlos Usilay Mejia',
  institute: 'UNSA'
};

// Variables para m√©tricas de rendimiento
let cursosEliminados = 0;
let tiempoInicio = Date.now();
let tiemposRespuesta = [];
let cursosDisponibles = [];
let errorConsecutivos = 0;

// Funci√≥n para obtener lista de cursos activos
function obtenerCursosActivos() {
  const cursosActivosUrl = `https://teammates-orugas.appspot.com/webapi/courses?entitytype=instructor&coursestatus=active`;
  const cursosRes = http.get(cursosActivosUrl, { headers: getHeadersWithCSRF() });
  
  if (cursosRes.status === 200 && cursosRes.body) {
    try {
      const cursosData = JSON.parse(cursosRes.body);
      let cursos = [];
      
      // Extraer cursos seg√∫n la estructura de respuesta
      if (Array.isArray(cursosData)) {
        cursos = cursosData;
      } else if (cursosData.courses && Array.isArray(cursosData.courses)) {
        cursos = cursosData.courses;
      } else if (cursosData.data && Array.isArray(cursosData.data)) {
        cursos = cursosData.data;
      }
      
      // Extraer IDs de cursos
      return cursos.map(curso => {
        if (typeof curso === 'string') return curso;
        return curso.courseId || curso.id || curso.course_id;
      }).filter(id => id && id.length > 0);
      
    } catch (e) {
      console.log(`‚ùå Error procesando lista de cursos: ${e.message}`);
      return [];
    }
  }
  return [];
}

// Funci√≥n para generar cursos de ejemplo si no hay suficientes
function generarCursoEjemplo(index) {
  const prefijos = ['CS', 'MATH', 'PHY', 'BIO', 'CHEM', 'ENG', 'HIST', 'ECON', 'PSYC', 'ART', 'MED', 'LAW', 'EDU', 'MUSIC', 'SPORT'];
  const prefijo = prefijos[index % prefijos.length];
  return `${prefijo}${101 + Math.floor(index / prefijos.length)}-ADMIN-${index}-${Date.now()}`;
}

export function setup() {
  console.log('üîç Obteniendo lista de cursos activos para eliminar...');
  cursosDisponibles = obtenerCursosActivos();
  
  if (cursosDisponibles.length > 0) {
    console.log(`‚úÖ Se encontraron ${cursosDisponibles.length} cursos activos disponibles para eliminar`);
  } else {
    console.log('‚ö†Ô∏è No se encontraron cursos activos. Se utilizar√°n IDs de ejemplo para el test.');
    // Generar IDs de ejemplo para testing
    for (let i = 0; i < 100; i++) {
      cursosDisponibles.push(generarCursoEjemplo(i));
    }
  }
  
  return { cursosDisponibles };
}

export default function (data) {
  const iterationId = __ITER;
  const totalIteraciones = 100;
  
  // Obtener curso a eliminar
  let cursoId;
  if (data.cursosDisponibles && data.cursosDisponibles.length > 0) {
    cursoId = data.cursosDisponibles[iterationId % data.cursosDisponibles.length];
  } else {
    cursoId = generarCursoEjemplo(iterationId);
  }
  
  console.log(`üóëÔ∏è Eliminando curso ${iterationId + 1}/100: ${cursoId}`);
  
  // URL del endpoint para eliminar curso (basado en el ejemplo proporcionado)
  const deleteUrl = `https://teammates-orugas.appspot.com/webapi/bin/course?courseid=${encodeURIComponent(cursoId)}`;
  
  // Payload vac√≠o para eliminaci√≥n (si es requerido)
  const payload = JSON.stringify({});
  
  const inicioRequest = Date.now();
  const deleteRes = http.put(deleteUrl, payload, { headers: getHeadersWithCSRF() });
  const tiempoRequest = Date.now() - inicioRequest;
  
  tiemposRespuesta.push(tiempoRequest);
  
  // Validaciones espec√≠ficas para acci√≥n masiva de eliminaci√≥n
  const validaciones = check(deleteRes, {
    '‚úÖ Respuesta HTTP exitosa': (r) => r.status === 200,
    '‚úÖ Acci√≥n r√°pida (‚â§3s)': (r) => tiempoRequest <= 3000,
    '‚úÖ Sin errores del servidor': (r) => r.status !== 500 && r.status !== 502 && r.status !== 503,
    '‚úÖ Autenticaci√≥n v√°lida': (r) => r.status !== 401 && r.status !== 403,
    '‚úÖ Curso encontrado': (r) => r.status !== 404,
    '‚úÖ Operaci√≥n permitida': (r) => r.status !== 405 && r.status !== 409,
    '‚úÖ Eliminaci√≥n exitosa': (r) => {
      // Verificar que el curso fue eliminado exitosamente
      if (r.status === 200) {
        try {
          // Si hay respuesta JSON, verificar campos de confirmaci√≥n
          if (r.body && r.body.trim() !== '') {
            const response = JSON.parse(r.body);
            // Buscar indicadores de eliminaci√≥n exitosa
            return response.deleted === true || 
                   response.success === true || 
                   response.status === 'deleted' ||
                   response.message?.includes('deleted') ||
                   response.message?.includes('removed');
          }
          // Si no hay body o est√° vac√≠o, asumir √©xito basado en HTTP 200
          return true;
        } catch {
          // Si no es JSON v√°lido pero status es 200, asumir √©xito
          return true;
        }
      }
      return false;
    },
  });

  // An√°lisis de validaciones
  const validacionesExitosas = Object.values(validaciones).filter(v => v === true).length;
  const totalValidaciones = Object.keys(validaciones).length;
  const porcentajeExito = Math.round((validacionesExitosas / totalValidaciones) * 100);

  // Contabilizar cursos eliminados exitosamente
  let realmenteEliminado = false;
  if (deleteRes.status === 200) {
    try {
      if (deleteRes.body && deleteRes.body.trim() !== '') {
        const response = JSON.parse(deleteRes.body);
        // Verificar indicadores de eliminaci√≥n
        realmenteEliminado = response.deleted === true || 
                           response.success === true || 
                           response.status === 'deleted' ||
                           response.message?.includes('deleted') ||
                           response.message?.includes('removed');
      } else {
        // Si no hay respuesta pero status 200, asumir √©xito
        realmenteEliminado = true;
      }
    } catch (e) {
      // Si error al parsear pero status 200, asumir √©xito
      realmenteEliminado = true;
    }
  }
  
  if (realmenteEliminado) {
    cursosEliminados++;
    errorConsecutivos = 0;
    console.log(`‚úÖ Curso ${iterationId + 1}/100 ELIMINADO exitosamente en ${tiempoRequest}ms - ${cursoId} (${validacionesExitosas}/${totalValidaciones} validaciones exitosas)`);
    
    if (tiempoRequest <= 3000) {
      console.log(`‚ö° Rendimiento excelente: Eliminado en ${tiempoRequest}ms (objetivo: ‚â§3s)`);
    }
  } else if (deleteRes.status === 200) {
    console.log(`‚ö†Ô∏è Curso ${iterationId + 1}/100 - HTTP 200 pero eliminaci√≥n incierta en ${tiempoRequest}ms - ${cursoId} (${validacionesExitosas}/${totalValidaciones} validaciones exitosas)`);
    console.log(`üîç Respuesta: ${deleteRes.body?.substring(0, 100)}...`);
    errorConsecutivos++;
  } else {
    errorConsecutivos++;
    console.log(`‚ùå Error eliminando curso ${iterationId + 1}/100 - Status ${deleteRes.status} en ${tiempoRequest}ms (${validacionesExitosas}/${totalValidaciones} validaciones exitosas)`);
    
    if (deleteRes.body) {
      console.log(`   Detalles: ${deleteRes.body.substring(0, 200)}`);
    }
    
    // Mostrar validaciones fallidas
    if (validacionesExitosas < totalValidaciones) {
      console.log(`‚ö†Ô∏è Validaciones fallidas:`);
      Object.entries(validaciones).forEach(([nombre, resultado]) => {
        if (!resultado) {
          console.log(`   ‚ùå ${nombre}`);
        }
      });
    }
    
    // Si hay muchos errores consecutivos, reportar problema
    if (errorConsecutivos >= 5) {
      console.log(`üö® ALERTA: ${errorConsecutivos} errores consecutivos detectados. Posible problema del sistema.`);
    }
  }
  
  // M√©tricas de progreso
  const progreso = Math.round(((iterationId + 1) / totalIteraciones) * 100);
  const tiempoTranscurrido = Math.round((Date.now() - tiempoInicio) / 1000);
  const cursosRestantes = totalIteraciones - (iterationId + 1);
  const tiempoPromedio = tiemposRespuesta.reduce((a, b) => a + b, 0) / tiemposRespuesta.length;
  const tiempoEstimado = Math.round((cursosRestantes * tiempoPromedio) / 1000);
  
  if ((iterationId + 1) % 10 === 0 || iterationId === 0) {
    console.log(`üìä Progreso: ${progreso}% (${iterationId + 1}/${totalIteraciones}) | Eliminados: ${cursosEliminados} | Tiempo: ${tiempoTranscurrido}s | ETA: ${tiempoEstimado}s`);
  }
  
  // Pausa m√≠nima entre requests para mantener rendimiento del backend
  sleep(0.1); // 100ms entre eliminaciones para eficiencia del backend
  
  return {
    iteration: iterationId + 1,
    courseId: cursoId,
    requestTime: tiempoRequest,
    status: deleteRes.status,
    success: realmenteEliminado, // Solo √©xito si realmente se elimin√≥
    httpSuccess: deleteRes.status === 200, // √âxito HTTP separado
    validationsSuccessful: validacionesExitosas,
    validationsTotal: totalValidaciones,
    validationsPercentage: porcentajeExito,
    validationResults: validaciones,
    consecutiveErrors: errorConsecutivos,
    totalDeleted: cursosEliminados,
    progress: progreso
  };
}

export function handleSummary(data) {
  const stats = {
    checksExitosos: data.metrics.checks?.values.passes || 0,
    checksTotal: data.metrics.checks?.values.count || 0,
    requestsTotal: data.metrics.http_reqs?.values.count || 0,
    duracionPromedio: Math.round(data.metrics.http_req_duration?.values.avg || 0),
    duracionMax: Math.round(data.metrics.http_req_duration?.values.max || 0),
    duracionMin: Math.round(data.metrics.http_req_duration?.values.min || 0),
    iteraciones: data.metrics.iterations?.values.count || 0,
    dataReceived: Math.round((data.metrics.data_received?.values.count || 0) / 1024) // KB
  };
  
  const exitoTotal = stats.checksTotal > 0 ? Math.round((stats.checksExitosos / stats.checksTotal) * 100) : 0;
  const cursosObjetivo = 100;
  const objetivoAlcanzado = cursosEliminados >= cursosObjetivo ? "‚úÖ CUMPLIDO" : cursosEliminados >= cursosObjetivo * 0.8 ? "‚ö†Ô∏è PARCIAL" : "‚ùå NO CUMPLIDO";
  const rendimientoObjetivo = stats.duracionPromedio <= 3000 ? "‚úÖ CUMPLE" : "‚ùå NO CUMPLE";
  const eficienciaBackend = stats.duracionPromedio <= 3000 && exitoTotal >= 80 ? "‚úÖ EFICIENTE" : "‚ö†Ô∏è REVISAR";
  
  const tiempoTotalSegundos = Math.round((Date.now() - tiempoInicio) / 1000);
  const tiempoTotalMinutos = Math.round(tiempoTotalSegundos / 60);
  const throughput = tiempoTotalSegundos > 0 ? Math.round((cursosEliminados / tiempoTotalSegundos) * 60) : 0; // cursos por minuto

  return {
    'stdout': `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  üóëÔ∏è PR-02.3-03: ACCI√ìN MASIVA - ELIMINAR TODOS LOS CURSOS ACTIVOS (100 CURSOS)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  üìä VALIDACIONES: ${stats.checksExitosos}/${stats.checksTotal} checks (${exitoTotal}%)
  üéØ CURSOS ELIMINADOS: ${cursosEliminados}/${cursosObjetivo} cursos - ${objetivoAlcanzado}
  ‚è±Ô∏è RENDIMIENTO: ${stats.duracionPromedio}ms promedio (objetivo: ‚â§3s) ${rendimientoObjetivo}
  üìà TIEMPOS: ${stats.duracionMin}ms min | ${stats.duracionMax}ms max
  üåê HTTP: ${stats.requestsTotal} requests PUT realizados
  ‚ö° THROUGHPUT: ${throughput} cursos/minuto
  üïê TIEMPO TOTAL: ${tiempoTotalMinutos} minutos (${tiempoTotalSegundos}s)
  üì¶ DATOS: ${stats.dataReceived}KB transferidos
  üîß EFICIENCIA BACKEND: ${eficienciaBackend}
  üîç ENDPOINT: PUT /webapi/bin/course?courseid={courseId}
  ‚úÖ OBJETIVO: Validar eficiencia del backend para acciones masivas de eliminaci√≥n
  
  üìã M√âTRICAS DETALLADAS:
  ‚Ä¢ Tasa de √©xito: ${Math.round((cursosEliminados / cursosObjetivo) * 100)}%
  ‚Ä¢ Tiempo promedio por curso: ${stats.duracionPromedio}ms
  ‚Ä¢ Cursos procesados por segundo: ${tiempoTotalSegundos > 0 ? Math.round(cursosEliminados / tiempoTotalSegundos) : 0}
  ‚Ä¢ Errores consecutivos m√°ximos: ${errorConsecutivos}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`
  };
}
